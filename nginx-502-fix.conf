# Enhanced nginx configuration to fix 502 Bad Gateway errors
# Add this to your server {} block

# Enable detailed error logging
error_log /var/log/nginx/expo-debug.log debug;

# Handle direct bundle requests with comprehensive settings
location ~ ^/index\.bundle {
    # Direct proxy to the Expo server (try both with and without $request_uri)
    proxy_pass http://127.0.0.1:3243$request_uri;
    
    # Essential headers for proper proxying
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Explicitly forward the original request URI
    proxy_set_header X-Original-URI $request_uri;
    
    # Set to prevent URL normalization issues
    proxy_pass_request_headers on;
    proxy_pass_request_body on;
    
    # Increased timeouts for large bundle responses
    proxy_connect_timeout 600;
    proxy_send_timeout 600;
    proxy_read_timeout 600;
    send_timeout 600;
    
    # Disable buffering for streaming response
    proxy_buffering off;
    
    # Handle large headers
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;
    
    # Force JavaScript MIME type
    proxy_hide_header Content-Type;
    add_header Content-Type application/javascript;
    
    # Disable compression for troubleshooting
    proxy_set_header Accept-Encoding "";
}

# Fallback location that just passes the full URL
location = /index.bundle {
    # Direct proxy to Expo server, explicit URL (alternative approach)
    proxy_pass http://127.0.0.1:3243/index.bundle?$args;
    
    # Essential headers
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    
    # Increased timeouts
    proxy_connect_timeout 600;
    proxy_send_timeout 600;
    proxy_read_timeout 600;
    
    # No buffering
    proxy_buffering off;
    
    # Force JavaScript MIME type
    proxy_hide_header Content-Type;
    add_header Content-Type application/javascript;
}