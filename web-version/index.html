<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AA Recovery Tracker</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: #4a86e8;
            color: white;
            padding: 15px 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            margin: 0;
            font-size: 24px;
        }
        .tab-navigation {
            display: flex;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .tab.active {
            background-color: #f0f7ff;
            border-bottom: 3px solid #4a86e8;
            font-weight: bold;
        }
        .tab-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .card-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #4a86e8;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            background-color: #4a86e8;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #3a76d8;
        }
        .fitness-score {
            font-size: 36px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: #4a86e8;
        }
        .metric-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .metric-label {
            font-weight: 500;
        }
        .activity-log {
            max-height: 400px;
            overflow-y: auto;
        }
        .activity-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .activity-date {
            font-size: 12px;
            color: #888;
        }
        .nearby-member {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background-color: #e1e1e1;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #777;
            font-weight: bold;
        }
        .member-info {
            flex: 1;
        }
        .member-distance {
            color: #4a86e8;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <header>
        <h1>AA Recovery Tracker</h1>
    </header>
    
    <div class="container">
        <div class="tab-navigation">
            <div class="tab active" onclick="showTab('dashboard')">Dashboard</div>
            <div class="tab" onclick="showTab('log')">Log Activity</div>
            <div class="tab" onclick="showTab('fitness')">Spiritual Fitness</div>
            <div class="tab" onclick="showTab('nearby')">Nearby Members</div>
        </div>
        
        <div id="dashboard" class="tab-content">
            <div class="card">
                <div class="card-title">Your Spiritual Fitness</div>
                <div class="fitness-score">8.7</div>
                <div class="metric-row">
                    <span class="metric-label">Meetings This Week</span>
                    <span>3 / 7</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Days Sober</span>
                    <span>137</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Prayer & Meditation</span>
                    <span>5 days streak</span>
                </div>
                <button onclick="showTab('log')">Log New Activity</button>
            </div>
            
            <div class="card">
                <div class="card-title">Recent Activities</div>
                <div class="activity-log">
                    <div class="activity-item">
                        <div class="activity-date">Today, 10:30 AM</div>
                        <div>Attended AA Meeting: First Avenue Group</div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-date">Yesterday, 8:15 PM</div>
                        <div>Call with Sponsor: 15 minutes</div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-date">2 days ago, 7:00 AM</div>
                        <div>Meditation: 20 minutes</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="log" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-title">Log New Activity</div>
                <form id="activity-form">
                    <div class="form-group">
                        <label for="activity-type">Activity Type</label>
                        <select id="activity-type">
                            <option value="meeting">AA Meeting</option>
                            <option value="meditation">Prayer & Meditation</option>
                            <option value="reading">AA Literature Reading</option>
                            <option value="sponsor">Sponsor Call/Meeting</option>
                            <option value="service">Service Work</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="activity-date">Date</label>
                        <input type="date" id="activity-date" value="2023-04-15">
                    </div>
                    
                    <div class="form-group">
                        <label for="activity-duration">Duration (minutes)</label>
                        <input type="number" id="activity-duration" value="60">
                    </div>
                    
                    <div class="form-group">
                        <label for="activity-notes">Notes</label>
                        <textarea id="activity-notes" rows="3"></textarea>
                    </div>
                    
                    <button type="button" onclick="logActivity()">Save Activity</button>
                </form>
            </div>
        </div>
        
        <div id="fitness" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-title">Spiritual Fitness Score</div>
                <div class="fitness-score">8.7</div>
                <p>Your spiritual fitness score is calculated based on your recovery activities, meeting attendance, and consistent practice of AA principles.</p>
            </div>
            
            <div class="card">
                <div class="card-title">Activity Breakdown</div>
                <div class="metric-row">
                    <span class="metric-label">Meeting Attendance</span>
                    <span>4.5 / 5</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Prayer & Meditation</span>
                    <span>3.8 / 5</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Literature Study</span>
                    <span>4.1 / 5</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Sponsorship</span>
                    <span>4.3 / 5</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Service Work</span>
                    <span>2.2 / 5</span>
                </div>
            </div>
        </div>
        
        <div id="nearby" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-title">Nearby AA Members</div>
                <p>These members have opted to share their location and are currently near you.</p>
                
                <div class="nearby-member">
                    <div class="member-avatar">JD</div>
                    <div class="member-info">
                        <div>John D.</div>
                        <div>Sobriety: 3 years</div>
                    </div>
                    <div class="member-distance">0.3 mi</div>
                </div>
                
                <div class="nearby-member">
                    <div class="member-avatar">SM</div>
                    <div class="member-info">
                        <div>Sarah M.</div>
                        <div>Sobriety: 7 months</div>
                    </div>
                    <div class="member-distance">0.8 mi</div>
                </div>
                
                <div class="nearby-member">
                    <div class="member-avatar">RK</div>
                    <div class="member-info">
                        <div>Robert K.</div>
                        <div>Sobriety: 5 years</div>
                    </div>
                    <div class="member-distance">1.2 mi</div>
                </div>
                
                <button onclick="startWizard()">Start Discovery Wizard</button>
            </div>
        </div>
    </div>

    <script>
        // App state
        let currentUser = null;
        let activities = [];
        let spiritualFitness = { score: 0, breakdown: {} };
        let nearbyMembers = [];

        // Fetch data from API
        async function fetchData() {
            try {
                // Get current user
                const userResponse = await fetch('/api/users/current');
                currentUser = await userResponse.json();
                
                // Get activities
                const activitiesResponse = await fetch('/api/activities');
                activities = await activitiesResponse.json();
                
                // Get spiritual fitness
                const fitnessResponse = await fetch('/api/spiritual-fitness');
                spiritualFitness = await fitnessResponse.json();
                
                // Get nearby members
                const membersResponse = await fetch('/api/nearby-members');
                nearbyMembers = await membersResponse.json();
                
                // Update UI
                updateDashboard();
                updateSpiritualFitness();
                updateNearbyMembers();
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Update dashboard
        function updateDashboard() {
            if (!currentUser || !activities.length) return;
            
            // Calculate days sober
            const sobrietyDate = new Date(currentUser.sobrietyDate);
            const today = new Date();
            const daysSober = Math.floor((today - sobrietyDate) / (1000 * 60 * 60 * 24));
            
            // Count meetings this week
            const weekStart = new Date();
            weekStart.setDate(today.getDate() - today.getDay());
            const meetingsThisWeek = activities.filter(a => 
                a.type === 'meeting' && new Date(a.date) >= weekStart
            ).length;
            
            // Update UI
            document.querySelector('.fitness-score').textContent = spiritualFitness.score;
            document.querySelector('.metric-row:nth-child(1) span:last-child').textContent = 
                `${meetingsThisWeek} / 7`;
            document.querySelector('.metric-row:nth-child(2) span:last-child').textContent = 
                daysSober;
            
            // Update activity log
            const activityLog = document.querySelector('.activity-log');
            activityLog.innerHTML = '';
            
            activities.slice(0, 5).forEach(activity => {
                const date = new Date(activity.date);
                const dateString = date.toLocaleDateString();
                const timeString = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                
                const activityDate = document.createElement('div');
                activityDate.className = 'activity-date';
                activityDate.textContent = `${dateString}, ${timeString}`;
                
                const activityContent = document.createElement('div');
                
                switch(activity.type) {
                    case 'meeting':
                        activityContent.textContent = `Attended AA Meeting: ${activity.notes}`;
                        break;
                    case 'sponsor':
                        activityContent.textContent = `Call with Sponsor: ${activity.duration} minutes`;
                        break;
                    case 'meditation':
                        activityContent.textContent = `Meditation: ${activity.duration} minutes`;
                        break;
                    case 'reading':
                        activityContent.textContent = `AA Literature Reading: ${activity.duration} minutes`;
                        break;
                    case 'service':
                        activityContent.textContent = `Service Work: ${activity.notes}`;
                        break;
                    default:
                        activityContent.textContent = `${activity.type}: ${activity.notes}`;
                }
                
                activityItem.appendChild(activityDate);
                activityItem.appendChild(activityContent);
                activityLog.appendChild(activityItem);
            });
        }

        // Update spiritual fitness page
        function updateSpiritualFitness() {
            if (!spiritualFitness) return;
            
            document.querySelector('#fitness .fitness-score').textContent = spiritualFitness.score;
            
            const breakdown = spiritualFitness.breakdown;
            document.querySelector('#fitness .metric-row:nth-child(1) span:last-child').textContent = 
                `${breakdown.meetingAttendance} / 5`;
            document.querySelector('#fitness .metric-row:nth-child(2) span:last-child').textContent = 
                `${breakdown.prayerMeditation} / 5`;
            document.querySelector('#fitness .metric-row:nth-child(3) span:last-child').textContent = 
                `${breakdown.literatureStudy} / 5`;
            document.querySelector('#fitness .metric-row:nth-child(4) span:last-child').textContent = 
                `${breakdown.sponsorship} / 5`;
            document.querySelector('#fitness .metric-row:nth-child(5) span:last-child').textContent = 
                `${breakdown.serviceWork} / 5`;
        }

        // Update nearby members page
        function updateNearbyMembers() {
            if (!nearbyMembers.length) return;
            
            const membersContainer = document.querySelector('#nearby .card');
            // Clear existing members (but keep the title and intro paragraph)
            const titleAndIntro = membersContainer.querySelectorAll(':nth-child(-n+2)');
            membersContainer.innerHTML = '';
            titleAndIntro.forEach(el => membersContainer.appendChild(el));
            
            // Add members
            nearbyMembers.forEach(member => {
                const memberElement = document.createElement('div');
                memberElement.className = 'nearby-member';
                
                const avatar = document.createElement('div');
                avatar.className = 'member-avatar';
                const initials = member.name.split(' ').map(n => n[0]).join('');
                avatar.textContent = initials;
                
                const info = document.createElement('div');
                info.className = 'member-info';
                
                const nameDiv = document.createElement('div');
                nameDiv.textContent = member.name;
                
                const sobrietyDiv = document.createElement('div');
                sobrietyDiv.textContent = `Sobriety: ${member.sobrietyTime}`;
                
                info.appendChild(nameDiv);
                info.appendChild(sobrietyDiv);
                
                const distance = document.createElement('div');
                distance.className = 'member-distance';
                distance.textContent = `${member.distance} mi`;
                
                memberElement.appendChild(avatar);
                memberElement.appendChild(info);
                memberElement.appendChild(distance);
                
                membersContainer.appendChild(memberElement);
            });
            
            // Add the discovery button
            const button = document.createElement('button');
            button.textContent = 'Start Discovery Wizard';
            button.onclick = startWizard;
            membersContainer.appendChild(button);
        }

        // Log a new activity
        async function logActivity() {
            const type = document.getElementById('activity-type').value;
            const date = document.getElementById('activity-date').value;
            const duration = document.getElementById('activity-duration').value;
            const notes = document.getElementById('activity-notes').value;
            
            const now = new Date();
            const time = now.toTimeString().split(' ')[0].substring(0, 5);
            const dateTime = `${date}T${time}`;
            
            try {
                const response = await fetch('/api/activities', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type,
                        date: dateTime,
                        duration: parseInt(duration),
                        notes
                    })
                });
                
                if (response.ok) {
                    alert('Activity logged successfully!');
                    
                    // Refresh data and go to dashboard
                    await fetchData();
                    showTab('dashboard');
                } else {
                    alert('Failed to log activity. Please try again.');
                }
            } catch (error) {
                console.error('Error logging activity:', error);
                alert('An error occurred. Please try again.');
            }
        }

        // Start the discovery wizard
        async function startWizard() {
            try {
                const response = await fetch('/api/discovery/start', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`Discovery Wizard started (ID: ${data.wizardId}, Step: ${data.step}). This would connect you with nearby members securely.`);
                } else {
                    alert('Failed to start discovery wizard. Please try again.');
                }
            } catch (error) {
                console.error('Error starting wizard:', error);
                alert('An error occurred. Please try again.');
            }
        }

        // Tab navigation
        function showTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabId).style.display = 'block';
            
            // Set active class on selected tab
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.textContent.toLowerCase().includes(tabId.toLowerCase())) {
                    tab.classList.add('active');
                }
            });
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            
            // Set current date in the activity form
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];
            document.getElementById('activity-date').value = dateString;
            
            // Add event listener to the activity form button
            document.querySelector('#activity-form button').addEventListener('click', logActivity);
        });
    </script>
</body>
</html>