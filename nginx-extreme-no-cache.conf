# Nginx configuration with extreme cache busting
# Include this in your server block or main nginx.conf

# Disable all caching for the entire site
location / {
    # Cache control headers
    add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
    add_header Surrogate-Control "no-store" always;
    
    # Disable browser caching completely
    etag off;
    if_modified_since off;
    
    # Add random timestamp to force cache invalidation
    add_header X-Cache-Timestamp $msec always;
    add_header X-App-Version "1.0.2-FORCE-REFRESH-${msec}" always;
    
    # Proxy to your Expo app
    proxy_pass http://localhost:3243;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # Disable proxy caching
    proxy_no_cache 1;
    proxy_cache_bypass 1;
    
    # Add random query string to all assets
    sub_filter '</head>' '<script>document.addEventListener("DOMContentLoaded", function() {
        var links = document.getElementsByTagName("link");
        var scripts = document.getElementsByTagName("script");
        var timestamp = Date.now();
        
        for (var i = 0; i < links.length; i++) {
            if (links[i].href && links[i].rel === "stylesheet") {
                links[i].href = links[i].href + "?v=" + timestamp;
            }
        }
        
        for (var j = 0; j < scripts.length; j++) {
            if (scripts[j].src) {
                scripts[j].src = scripts[j].src + "?v=" + timestamp;
            }
        }
    });</script></head>';
    sub_filter_once on;
}

# Special case for bundle files - always serve fresh
location ~ \.bundle$ {
    add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
    
    proxy_pass http://localhost:3243;
    proxy_http_version 1.1;
    proxy_no_cache 1;
    proxy_cache_bypass 1;
}

# Add timestamp to all static files
location ~* \.(js|css|png|jpg|jpeg|gif|svg|woff|woff2|ttf|eot)$ {
    add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
    
    proxy_pass http://localhost:3243;
    proxy_no_cache 1;
    proxy_cache_bypass 1;
}