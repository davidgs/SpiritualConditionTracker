<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spiritual Condition Tracker</title>
  <!-- Include Tailwind CSS -->
  <link rel="stylesheet" href="/app/styles/tailwind.css">
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <link rel="icon" type="image/jpg" href="/logo.jpg">
  
  <!-- Load the database module first -->
  <script src="database.js"></script>

  <!-- Custom styles -->
  <style>
    .card {
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
      padding: 1rem;
      margin-bottom: 1rem;
    }
    
    .btn-primary {
      background-color: #3b82f6;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      transition: background-color 0.2s;
    }
    
    .btn-primary:hover {
      background-color: #2563eb;
    }
    
    .container {
      max-width: 28rem;
      margin-left: auto;
      margin-right: auto;
      padding-left: 1rem;
      padding-right: 1rem;
      padding-bottom: 5rem;
      padding-top: 1rem;
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.75rem 0;
      flex: 1;
      color: #6b7280;
    }
    
    .nav-item.active {
      color: #3b82f6;
    }
    
    .nav-item i {
      font-size: 1.25rem;
    }
    
    .nav-item span {
      font-size: 0.75rem;
      margin-top: 0.25rem;
    }
    
    .activity-icon {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 9999px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .meeting-icon {
      background-color: #dbeafe;
      color: #3b82f6;
    }
    
    .meditation-icon {
      background-color: #dcfce7;
      color: #22c55e;
    }
    
    .reading-icon {
      background-color: #f3e8ff;
      color: #a855f7;
    }
    
    .prayer-icon {
      background-color: #e0e7ff;
      color: #6366f1;
    }
    
    .sponsor-icon {
      background-color: #fef9c3;
      color: #eab308;
    }
    
    .service-icon {
      background-color: #fee2e2;
      color: #ef4444;
    }
    
    .hidden {
      display: none;
    }
    
    .progress-bar {
      height: 0.5rem;
      background-color: #e5e7eb;
      border-radius: 0.25rem;
      overflow: hidden;
    }
    
    .progress-bar-fill {
      height: 100%;
      background-color: #3b82f6;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app" class="container">
    <!-- Loading screen -->
    <div id="loading-screen" class="flex justify-center items-center" style="height: 90vh;">
      <div class="text-center">
        <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
        <p class="text-gray-600">Loading Spiritual Condition Tracker...</p>
      </div>
    </div>
    
    <!-- Dashboard View -->
    <div id="dashboard-view" class="view hidden">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-semibold text-gray-800">Your Recovery Journey</h2>
        <button id="log-activity-btn" class="btn-primary">
          <i class="fa-solid fa-plus mr-2"></i>
          Log
        </button>
      </div>
      
      <!-- Spiritual Fitness Card -->
      <div class="card bg-gradient-to-r from-blue-500 to-blue-600 text-white">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-lg font-medium mb-1">Spiritual Fitness</h3>
            <p class="text-white opacity-80 text-sm">Based on your recent activities</p>
          </div>
          <div class="text-right">
            <div id="fitness-score" class="text-3xl font-bold">0.00%</div>
            <button id="view-fitness-btn" class="text-sm text-white opacity-90 hover:opacity-100 mt-1">
              View Details <i class="fa-solid fa-arrow-right ml-1"></i>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Streaks -->
      <div class="card">
        <h3 class="text-lg font-medium mb-3">Current Streaks</h3>
        <div class="grid grid-cols-3 gap-4">
          <div class="text-center p-3 bg-blue-50 rounded-lg">
            <i class="fa-solid fa-users text-2xl text-blue-500 mb-2"></i>
            <p id="meeting-streak" class="font-semibold text-xl">0</p>
            <p class="text-sm text-gray-600">Meetings</p>
          </div>
          <div class="text-center p-3 bg-green-50 rounded-lg">
            <i class="fa-solid fa-brain text-2xl text-green-500 mb-2"></i>
            <p id="meditation-streak" class="font-semibold text-xl">0</p>
            <p class="text-sm text-gray-600">Meditation</p>
          </div>
          <div class="text-center p-3 bg-purple-50 rounded-lg">
            <i class="fa-solid fa-book text-2xl text-purple-500 mb-2"></i>
            <p id="reading-streak" class="font-semibold text-xl">0</p>
            <p class="text-sm text-gray-600">Reading</p>
          </div>
        </div>
      </div>
      
      <!-- Recent Activities -->
      <div class="card">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg font-medium">Recent Activities</h3>
          <button id="view-history-btn" class="text-sm text-blue-600 hover:text-blue-800">
            View All
          </button>
        </div>
        
        <div id="recent-activities-list" class="space-y-3">
          <!-- Activities will be added here dynamically -->
        </div>
        
        <div id="no-activities" class="text-center py-6 hidden">
          <p class="text-gray-500">No activities logged yet.</p>
          <button id="first-activity-btn" class="mt-2 btn-primary">
            Log Your First Activity
          </button>
        </div>
      </div>
      
      <!-- Nearby AA Members Card -->
      <div class="card bg-gradient-to-r from-purple-50 to-blue-50">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-lg font-medium mb-1">Nearby AA Members</h3>
            <p class="text-gray-600 text-sm">Connect with others in your area</p>
          </div>
          <button id="find-members-btn" class="btn-primary">
            <i class="fa-solid fa-users mr-2"></i>
            Find
          </button>
        </div>
      </div>
    </div>
    
    <!-- Activity Log View -->
    <div id="activity-log-view" class="view hidden">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-semibold text-gray-800">Log Activity</h2>
        <button class="back-btn text-blue-500 hover:text-blue-700">
          <i class="fa-solid fa-arrow-left mr-1"></i> Back
        </button>
      </div>
      
      <div class="card">
        <h3 class="text-lg font-medium mb-4">New Activity</h3>
        
        <form id="activity-form" class="space-y-4">
          <div>
            <label class="block text-gray-700 text-sm font-medium mb-2">Activity Type</label>
            <select id="activity-type" class="w-full px-3 py-2 border border-gray-300 rounded-md">
              <option value="meeting">Meeting</option>
              <option value="meditation">Meditation</option>
              <option value="reading">Reading</option>
              <option value="prayer">Prayer</option>
              <option value="sponsor">Sponsor Interaction</option>
              <option value="service">Service Work</option>
            </select>
          </div>
          
          <div>
            <label class="block text-gray-700 text-sm font-medium mb-2">Name (Optional)</label>
            <input type="text" id="activity-name" placeholder="Meeting name, book title, etc." class="w-full px-3 py-2 border border-gray-300 rounded-md">
          </div>
          
          <div>
            <label class="block text-gray-700 text-sm font-medium mb-2">Duration (minutes)</label>
            <input type="number" id="activity-duration" min="1" value="60" class="w-full px-3 py-2 border border-gray-300 rounded-md">
          </div>
          
          <div>
            <label class="block text-gray-700 text-sm font-medium mb-2">Date</label>
            <input type="date" id="activity-date" class="w-full px-3 py-2 border border-gray-300 rounded-md">
          </div>
          
          <div>
            <label class="block text-gray-700 text-sm font-medium mb-2">Notes (Optional)</label>
            <textarea id="activity-notes" rows="3" placeholder="Any additional notes..." class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
          </div>
          
          <button type="submit" class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600">
            Save Activity
          </button>
        </form>
      </div>
    </div>
    
    <!-- Spiritual Fitness View -->
    <div id="fitness-view" class="view hidden">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-semibold text-gray-800">Spiritual Fitness</h2>
        <button class="back-btn text-blue-500 hover:text-blue-700">
          <i class="fa-solid fa-arrow-left mr-1"></i> Back
        </button>
      </div>
      
      <!-- Score Card -->
      <div class="card bg-blue-500 text-white">
        <div class="text-center">
          <h3 class="text-xl font-semibold mb-2">Your Score</h3>
          <div id="fitness-detail-score" class="text-5xl font-bold mb-2">0.00%</div>
          <p class="text-white opacity-80">Based on your activities in the last 30 days</p>
        </div>
      </div>
      
      <!-- Score Breakdown -->
      <div class="card">
        <h3 class="text-lg font-medium mb-4">Score Breakdown</h3>
        
        <!-- Meeting Attendance -->
        <div class="mb-6">
          <div class="flex justify-between mb-1">
            <span class="font-medium">Meeting Attendance</span>
            <span id="meeting-score" class="text-blue-600 font-medium">0.0/3.0</span>
          </div>
          <div class="progress-bar">
            <div id="meeting-progress" class="progress-bar-fill bg-blue-500" style="width: 0%"></div>
          </div>
          <p id="meeting-count" class="text-sm text-gray-500 mt-1">
            0 meetings in the last 30 days
          </p>
        </div>
        
        <!-- Prayer & Meditation -->
        <div class="mb-6">
          <div class="flex justify-between mb-1">
            <span class="font-medium">Prayer & Meditation</span>
            <span id="prayer-score" class="text-green-600 font-medium">0.0/2.0</span>
          </div>
          <div class="progress-bar">
            <div id="prayer-progress" class="progress-bar-fill bg-green-500" style="width: 0%"></div>
          </div>
          <p id="prayer-count" class="text-sm text-gray-500 mt-1">
            0 sessions in the last 30 days
          </p>
        </div>
        
        <!-- Reading AA Literature -->
        <div class="mb-6">
          <div class="flex justify-between mb-1">
            <span class="font-medium">Reading AA Literature</span>
            <span id="reading-score" class="text-purple-600 font-medium">0.0/1.5</span>
          </div>
          <div class="progress-bar">
            <div id="reading-progress" class="progress-bar-fill bg-purple-500" style="width: 0%"></div>
          </div>
          <p id="reading-count" class="text-sm text-gray-500 mt-1">
            0 reading sessions in the last 30 days
          </p>
        </div>
      </div>
    </div>
    
    <!-- History View -->
    <div id="history-view" class="view hidden">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-semibold text-gray-800">Activity History</h2>
        <button class="back-btn text-blue-500 hover:text-blue-700">
          <i class="fa-solid fa-arrow-left mr-1"></i> Back
        </button>
      </div>
      
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium">All Activities</h3>
        <button id="new-activity-btn" class="btn-primary">
          <i class="fa-solid fa-plus mr-2"></i>
          New
        </button>
      </div>
      
      <div id="activity-history-list" class="space-y-4">
        <!-- Activities will be added here dynamically -->
      </div>
      
      <div id="no-history" class="card text-center py-8 hidden">
        <i class="fa-solid fa-folder-open text-gray-300 text-5xl mb-3"></i>
        <h3 class="text-lg font-medium text-gray-700 mb-2">No Activities Yet</h3>
        <p class="text-gray-500 mb-4">Start tracking your recovery journey by logging your first activity.</p>
        <button id="start-activity-btn" class="btn-primary">
          Log First Activity
        </button>
      </div>
    </div>
    
    <!-- Nearby View -->
    <div id="nearby-view" class="view hidden">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-semibold text-gray-800">Nearby AA Members</h2>
        <button class="back-btn text-blue-500 hover:text-blue-700">
          <i class="fa-solid fa-arrow-left mr-1"></i> Back
        </button>
      </div>
      
      <div class="card">
        <div class="text-center p-6">
          <i class="fa-solid fa-location-dot text-blue-500 text-5xl mb-4"></i>
          <h3 class="text-xl font-medium mb-2">Find Members Nearby</h3>
          <p class="text-gray-600 mb-6">Connect with other AA members in your area for support and fellowship.</p>
          
          <button id="start-discovery" class="btn-primary w-full">
            <i class="fa-solid fa-broadcast-tower mr-2"></i>
            Start Discovery
          </button>
          
          <p class="text-xs text-gray-500 mt-4">
            Your privacy is protected. Your location and personal information are only shared when you choose to connect.
          </p>
        </div>
      </div>
      
      <!-- Privacy Settings Card -->
      <div class="card">
        <h3 class="text-lg font-medium mb-4">Discovery Settings</h3>
        
        <div class="flex items-center justify-between mb-4">
          <div>
            <p class="font-medium text-gray-800">Share My Location</p>
            <p class="text-sm text-gray-500">Allow nearby members to see you</p>
          </div>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="share-location" class="sr-only peer">
            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
          </label>
        </div>
        
        <div class="flex items-center justify-between">
          <div>
            <p class="font-medium text-gray-800">Share Activities</p>
            <p class="text-sm text-gray-500">Share recent activities with connections</p>
          </div>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="share-activities" class="sr-only peer">
            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
          </label>
        </div>
      </div>
    </div>
    
    <!-- Profile View -->
    <div id="profile-view" class="view hidden">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-semibold text-gray-800">Profile</h2>
        <button class="back-btn text-blue-500 hover:text-blue-700">
          <i class="fa-solid fa-arrow-left mr-1"></i> Back
        </button>
      </div>
      
      <!-- Profile Card -->
      <div class="card text-center">
        <div class="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fa-solid fa-user text-blue-500 text-4xl"></i>
        </div>
        <h3 id="profile-display-name" class="text-xl font-semibold mb-1">User</h3>
        <p id="profile-member-since" class="text-gray-500 mb-4">Member since -</p>
        
        <div class="flex justify-center space-x-8 mb-2">
          <div class="text-center">
            <div id="sobriety-days" class="text-2xl font-bold text-green-500">0</div>
            <div class="text-sm text-gray-500">Days</div>
          </div>
          <div class="text-center">
            <div id="sobriety-years" class="text-2xl font-bold text-green-500">0.00</div>
            <div class="text-sm text-gray-500">Years</div>
          </div>
        </div>
        
        <p id="sober-since" class="text-sm text-gray-500">
          Sober since -
        </p>
      </div>
      
      <!-- Profile Form -->
      <div class="card">
        <h3 class="text-lg font-medium mb-4">Personal Information</h3>
        
        <form id="profile-form" class="space-y-4">
          <div>
            <label class="block text-gray-700 text-sm font-medium mb-2">Name</label>
            <input type="text" id="profile-name" class="w-full px-3 py-2 border border-gray-300 rounded-md">
          </div>
          
          <div>
            <label class="block text-gray-700 text-sm font-medium mb-2">Sobriety Date</label>
            <input type="date" id="profile-sobriety-date" class="w-full px-3 py-2 border border-gray-300 rounded-md">
          </div>
          
          <div>
            <label class="block text-gray-700 text-sm font-medium mb-2">Home Group</label>
            <input type="text" id="profile-home-group" class="w-full px-3 py-2 border border-gray-300 rounded-md">
          </div>
          
          <div>
            <label class="block text-gray-700 text-sm font-medium mb-2">Phone</label>
            <input type="tel" id="profile-phone" class="w-full px-3 py-2 border border-gray-300 rounded-md">
          </div>
          
          <div>
            <label class="block text-gray-700 text-sm font-medium mb-2">Email</label>
            <input type="email" id="profile-email" class="w-full px-3 py-2 border border-gray-300 rounded-md">
          </div>
          
          <button type="submit" class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600">
            Save Profile
          </button>
        </form>
      </div>
    </div>
    
    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-lg z-10">
      <div class="flex justify-around">
        <button data-view="dashboard" class="nav-item active">
          <i class="fa-solid fa-house"></i>
          <span>Dashboard</span>
        </button>
        <button data-view="activity-log" class="nav-item">
          <i class="fa-solid fa-plus"></i>
          <span>Log Activity</span>
        </button>
        <button data-view="fitness" class="nav-item">
          <i class="fa-solid fa-heart"></i>
          <span>Fitness</span>
        </button>
        <button data-view="history" class="nav-item">
          <i class="fa-solid fa-clock-rotate-left"></i>
          <span>History</span>
        </button>
        <button data-view="nearby" class="nav-item">
          <i class="fa-solid fa-users"></i>
          <span>Nearby</span>
        </button>
        <button data-view="profile" class="nav-item">
          <i class="fa-solid fa-user"></i>
          <span>Profile</span>
        </button>
      </div>
    </nav>
  </div>

  <script>
    // Application state
    const app = {
      currentView: 'dashboard',
      user: null,
      activities: [],
      spiritualFitness: { score: 0 },
      
      // Initialize the application
      async init() {
        console.log('Initializing app...');
        try {
          // Show loading screen
          document.getElementById('loading-screen').style.display = 'flex';
          
          // Initialize database
          await this.initDatabase();
          
          // Load user data
          await this.loadUserData();
          
          // Set up event listeners
          this.setupEventListeners();
          
          // Hide loading screen and show dashboard
          document.getElementById('loading-screen').style.display = 'none';
          this.navigateTo('dashboard');
          
        } catch (error) {
          console.error('Error initializing app:', error);
          this.showError('Failed to initialize the application. Please try again later.');
        }
      },
      
      // Initialize the database
      async initDatabase() {
        console.log('Initializing database...');
        if (!window.Database) {
          throw new Error('Database module not loaded');
        }
        
        try {
          await window.Database.initDatabase();
          
          // Check if we have any users
          const users = window.Database.userOperations.getAll();
          
          if (!users || users.length === 0) {
            console.log('Creating default user...');
            // Create a default user
            window.Database.userOperations.create({
              name: 'Test User',
              sobrietyDate: '2020-01-01',
              homeGroup: 'Thursday Night Group',
              phone: '555-123-4567',
              email: 'test@example.com',
              privacySettings: {
                shareLocation: false,
                shareActivities: true
              }
            });
          }
          
          console.log('Database initialization complete');
        } catch (error) {
          console.error('Error initializing database:', error);
          throw error;
        }
      },
      
      // Load user data
      async loadUserData() {
        try {
          // Get the first user
          const users = window.Database.userOperations.getAll();
          if (!users || users.length === 0) {
            throw new Error('No user found in database');
          }
          
          this.user = users[0];
          console.log('User data loaded:', this.user);
          
          // Load activities for this user
          this.activities = window.Database.activityOperations.getAll({ 
            userId: this.user.id 
          }) || [];
          
          // Calculate spiritual fitness
          this.spiritualFitness = window.Database.spiritualFitnessOperations.calculateAndSave(
            this.user.id, 
            this.activities
          );
          
          // Initialize today's date for activity form
          const today = new Date().toISOString().split('T')[0];
          document.getElementById('activity-date').value = today;
          
          // Update privacy toggles
          document.getElementById('share-location').checked = this.user.privacySettings?.shareLocation || false;
          document.getElementById('share-activities').checked = this.user.privacySettings?.shareActivities || false;
          
          // Update dashboard
          this.updateDashboard();
          
          // Update fitness view
          this.updateFitnessView();
          
          // Update activity history
          this.updateActivityHistory();
          
          // Update profile view
          this.updateProfileView();
          
        } catch (error) {
          console.error('Error loading user data:', error);
          throw error;
        }
      },
      
      // Set up event listeners
      setupEventListeners() {
        // Navigation buttons
        const navButtons = document.querySelectorAll('.nav-item');
        navButtons.forEach(button => {
          button.addEventListener('click', () => {
            const view = button.getAttribute('data-view');
            this.navigateTo(view);
          });
        });
        
        // Back buttons
        const backButtons = document.querySelectorAll('.back-btn');
        backButtons.forEach(button => {
          button.addEventListener('click', () => {
            this.navigateTo('dashboard');
          });
        });
        
        // Dashboard buttons
        document.getElementById('log-activity-btn').addEventListener('click', () => {
          this.navigateTo('activity-log');
        });
        
        document.getElementById('view-fitness-btn').addEventListener('click', () => {
          this.navigateTo('fitness');
        });
        
        document.getElementById('view-history-btn').addEventListener('click', () => {
          this.navigateTo('history');
        });
        
        document.getElementById('find-members-btn').addEventListener('click', () => {
          this.navigateTo('nearby');
        });
        
        document.getElementById('first-activity-btn')?.addEventListener('click', () => {
          this.navigateTo('activity-log');
        });
        
        // Activity form
        document.getElementById('activity-form').addEventListener('submit', (e) => {
          e.preventDefault();
          this.saveActivity();
        });
        
        // History buttons
        document.getElementById('new-activity-btn').addEventListener('click', () => {
          this.navigateTo('activity-log');
        });
        
        document.getElementById('start-activity-btn')?.addEventListener('click', () => {
          this.navigateTo('activity-log');
        });
        
        // Nearby view
        document.getElementById('start-discovery').addEventListener('click', () => {
          alert('This feature is coming soon!');
        });
        
        document.getElementById('share-location').addEventListener('change', (e) => {
          this.updatePrivacySettings('shareLocation', e.target.checked);
        });
        
        document.getElementById('share-activities').addEventListener('change', (e) => {
          this.updatePrivacySettings('shareActivities', e.target.checked);
        });
        
        // Profile form
        document.getElementById('profile-form').addEventListener('submit', (e) => {
          e.preventDefault();
          this.saveProfile();
        });
      },
      
      // Navigate to a view
      navigateTo(view) {
        // Hide all views
        const views = document.querySelectorAll('.view');
        views.forEach(v => v.classList.add('hidden'));
        
        // Show requested view
        document.getElementById(`${view}-view`)?.classList.remove('hidden');
        
        // Update navigation
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
          if (item.getAttribute('data-view') === view) {
            item.classList.add('active');
          } else {
            item.classList.remove('active');
          }
        });
        
        // Update currentView
        this.currentView = view;
      },
      
      // Update dashboard with current data
      updateDashboard() {
        // Update spiritual fitness score
        document.getElementById('fitness-score').textContent = 
          `${this.spiritualFitness?.score ? this.spiritualFitness.score.toFixed(2) : "0.00"}%`;
        
        // Calculate streaks
        const streaks = this.calculateStreaks();
        document.getElementById('meeting-streak').textContent = streaks.meetings;
        document.getElementById('meditation-streak').textContent = streaks.meditation;
        document.getElementById('reading-streak').textContent = streaks.reading;
        
        // Update recent activities
        const recentActivities = this.activities
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .slice(0, 5);
          
        const recentActivitiesList = document.getElementById('recent-activities-list');
        recentActivitiesList.innerHTML = '';
        
        if (recentActivities.length === 0) {
          document.getElementById('no-activities').classList.remove('hidden');
        } else {
          document.getElementById('no-activities').classList.add('hidden');
          
          recentActivities.forEach(activity => {
            const activityEl = document.createElement('div');
            activityEl.className = 'flex items-center p-3 border border-gray-100 rounded-lg hover:bg-gray-50';
            
            // Get icon class
            let iconClass = 'activity-icon ';
            switch (activity.type) {
              case 'meeting': iconClass += 'meeting-icon'; break;
              case 'meditation': iconClass += 'meditation-icon'; break;
              case 'reading': iconClass += 'reading-icon'; break;
              case 'prayer': iconClass += 'prayer-icon'; break;
              case 'sponsor': iconClass += 'sponsor-icon'; break;
              case 'service': iconClass += 'service-icon'; break;
              default: iconClass += 'meeting-icon';
            }
            
            // Get icon
            let icon = '';
            switch (activity.type) {
              case 'meeting': icon = 'fa-solid fa-users'; break;
              case 'meditation': icon = 'fa-solid fa-brain'; break;
              case 'reading': icon = 'fa-solid fa-book'; break;
              case 'prayer': icon = 'fa-solid fa-praying-hands'; break;
              case 'sponsor': icon = 'fa-solid fa-handshake'; break;
              case 'service': icon = 'fa-solid fa-hands-helping'; break;
              default: icon = 'fa-solid fa-star';
            }
            
            activityEl.innerHTML = `
              <div class="${iconClass}">
                <i class="${icon}"></i>
              </div>
              <div class="ml-3 flex-1">
                <div class="font-medium text-gray-800">
                  ${activity.type.charAt(0).toUpperCase() + activity.type.slice(1)}
                  ${activity.name ? `: ${activity.name}` : ''}
                </div>
                <div class="text-sm text-gray-500">
                  ${activity.duration} min · ${new Date(activity.date).toLocaleDateString()}
                </div>
              </div>
            `;
            
            recentActivitiesList.appendChild(activityEl);
          });
        }
      },
      
      // Calculate streaks for activities
      calculateStreaks() {
        if (!this.activities || this.activities.length === 0) {
          return { meetings: 0, meditation: 0, reading: 0 };
        }
        
        // Group activities by type
        const grouped = this.activities.reduce((acc, activity) => {
          if (!acc[activity.type]) acc[activity.type] = [];
          acc[activity.type].push(activity);
          return acc;
        }, {});
        
        // Calculate streak for each type
        const today = new Date();
        const calculateStreak = (activities, daysBack = 7) => {
          if (!activities || activities.length === 0) return 0;
          
          activities.sort((a, b) => new Date(b.date) - new Date(a.date));
          
          let streak = 0;
          let currentDate = new Date(today);
          
          for (let i = 0; i < daysBack; i++) {
            const dateStr = currentDate.toISOString().split('T')[0];
            const found = activities.some(a => a.date.split('T')[0] === dateStr);
            
            if (found) {
              streak++;
            } else if (streak > 0) {
              break;
            }
            
            currentDate.setDate(currentDate.getDate() - 1);
          }
          
          return streak;
        };
        
        return {
          meetings: calculateStreak(grouped['meeting']),
          meditation: calculateStreak(grouped['meditation']),
          reading: calculateStreak(grouped['reading'])
        };
      },
      
      // Update spiritual fitness view
      updateFitnessView() {
        const components = this.spiritualFitness?.components || {};
        const activityCounts = this.spiritualFitness?.activityCounts || {};
        
        // Update score
        document.getElementById('fitness-detail-score').textContent = 
          `${this.spiritualFitness?.score ? this.spiritualFitness.score.toFixed(2) : "0.00"}%`;
        
        // Update component scores
        const meetingScore = (components.meetings || 0) * 3;
        document.getElementById('meeting-score').textContent = `${meetingScore.toFixed(1)}/3.0`;
        document.getElementById('meeting-progress').style.width = `${Math.min(meetingScore / 3 * 100, 100)}%`;
        document.getElementById('meeting-count').textContent = 
          `${activityCounts.meeting || 0} meetings in the last 30 days`;
        
        const prayerScore = (components.prayer || 0) * 2;
        document.getElementById('prayer-score').textContent = `${prayerScore.toFixed(1)}/2.0`;
        document.getElementById('prayer-progress').style.width = `${Math.min(prayerScore / 2 * 100, 100)}%`;
        document.getElementById('prayer-count').textContent = 
          `${(activityCounts.prayer || 0) + (activityCounts.meditation || 0)} sessions in the last 30 days`;
        
        const readingScore = (components.reading || 0) * 1.5;
        document.getElementById('reading-score').textContent = `${readingScore.toFixed(1)}/1.5`;
        document.getElementById('reading-progress').style.width = `${Math.min(readingScore / 1.5 * 100, 100)}%`;
        document.getElementById('reading-count').textContent = 
          `${activityCounts.reading || 0} reading sessions in the last 30 days`;
      },
      
      // Update activity history
      updateActivityHistory() {
        // Sort activities by date, newest first
        const sortedActivities = [...this.activities].sort((a, b) => 
          new Date(b.date) - new Date(a.date)
        );
        
        const historyList = document.getElementById('activity-history-list');
        historyList.innerHTML = '';
        
        if (sortedActivities.length === 0) {
          document.getElementById('no-history').classList.remove('hidden');
        } else {
          document.getElementById('no-history').classList.add('hidden');
          
          sortedActivities.forEach(activity => {
            const activityEl = document.createElement('div');
            activityEl.className = 'card hover:shadow-md transition';
            
            // Get icon class
            let iconClass = 'activity-icon ';
            switch (activity.type) {
              case 'meeting': iconClass += 'meeting-icon'; break;
              case 'meditation': iconClass += 'meditation-icon'; break;
              case 'reading': iconClass += 'reading-icon'; break;
              case 'prayer': iconClass += 'prayer-icon'; break;
              case 'sponsor': iconClass += 'sponsor-icon'; break;
              case 'service': iconClass += 'service-icon'; break;
              default: iconClass += 'meeting-icon';
            }
            
            // Get icon
            let icon = '';
            switch (activity.type) {
              case 'meeting': icon = 'fa-solid fa-users'; break;
              case 'meditation': icon = 'fa-solid fa-brain'; break;
              case 'reading': icon = 'fa-solid fa-book'; break;
              case 'prayer': icon = 'fa-solid fa-praying-hands'; break;
              case 'sponsor': icon = 'fa-solid fa-handshake'; break;
              case 'service': icon = 'fa-solid fa-hands-helping'; break;
              default: icon = 'fa-solid fa-star';
            }
            
            activityEl.innerHTML = `
              <div class="flex items-center">
                <div class="${iconClass}">
                  <i class="${icon}"></i>
                </div>
                <div class="ml-3 flex-1">
                  <div class="font-medium text-gray-800 flex justify-between">
                    <span>
                      ${activity.type.charAt(0).toUpperCase() + activity.type.slice(1)}
                      ${activity.name ? `: ${activity.name}` : ''}
                    </span>
                    <span class="text-sm text-gray-500">
                      ${new Date(activity.date).toLocaleDateString()}
                    </span>
                  </div>
                  <div class="text-sm text-gray-600">
                    Duration: ${activity.duration} minutes
                  </div>
                  ${activity.notes ? `<p class="mt-2 text-sm text-gray-600">${activity.notes}</p>` : ''}
                </div>
              </div>
            `;
            
            historyList.appendChild(activityEl);
          });
        }
      },
      
      // Update profile view
      updateProfileView() {
        // Get sobriety stats
        const sobrietyDays = this.user?.sobrietyDate ? 
          window.Database.calculateSobrietyDays(this.user.sobrietyDate) : 0;
          
        const sobrietyYears = this.user?.sobrietyDate ? 
          window.Database.calculateSobrietyYears(this.user.sobrietyDate) : 0;
        
        // Update display elements
        document.getElementById('profile-display-name').textContent = this.user?.name || 'User';
        document.getElementById('profile-member-since').textContent = 
          `Member since ${new Date(this.user?.createdAt || Date.now()).toLocaleDateString()}`;
          
        document.getElementById('sobriety-days').textContent = sobrietyDays;
        document.getElementById('sobriety-years').textContent = sobrietyYears.toFixed(2);
        
        document.getElementById('sober-since').textContent = 
          `Sober since ${this.user?.sobrietyDate ? new Date(this.user.sobrietyDate).toLocaleDateString() : 'Not set'}`;
        
        // Set form values
        document.getElementById('profile-name').value = this.user?.name || '';
        document.getElementById('profile-sobriety-date').value = this.user?.sobrietyDate || '';
        document.getElementById('profile-home-group').value = this.user?.homeGroup || '';
        document.getElementById('profile-phone').value = this.user?.phone || '';
        document.getElementById('profile-email').value = this.user?.email || '';
      },
      
      // Save a new activity
      saveActivity() {
        const type = document.getElementById('activity-type').value;
        const name = document.getElementById('activity-name').value;
        const duration = parseInt(document.getElementById('activity-duration').value, 10);
        const date = document.getElementById('activity-date').value;
        const notes = document.getElementById('activity-notes').value;
        
        try {
          // Add to database
          const savedActivity = window.Database.activityOperations.create({
            userId: this.user.id,
            type,
            name,
            duration,
            date,
            notes
          });
          
          // Update activities in app state
          this.activities.push(savedActivity);
          
          // Recalculate spiritual fitness
          this.spiritualFitness = window.Database.spiritualFitnessOperations.calculateAndSave(
            this.user.id, 
            this.activities
          );
          
          // Update views
          this.updateDashboard();
          this.updateFitnessView();
          this.updateActivityHistory();
          
          // Return to dashboard
          this.navigateTo('dashboard');
          
        } catch (error) {
          console.error('Error saving activity:', error);
          alert('There was an error saving your activity. Please try again.');
        }
      },
      
      // Update privacy settings
      updatePrivacySettings(setting, value) {
        try {
          // Update privacy settings
          const updatedSettings = {
            ...this.user.privacySettings,
            [setting]: value
          };
          
          // Update in database
          window.Database.userOperations.update(this.user.id, {
            privacySettings: updatedSettings
          });
          
          // Update user in app state
          this.user.privacySettings = updatedSettings;
          
        } catch (error) {
          console.error('Error updating privacy settings:', error);
          alert('There was an error updating your privacy settings.');
        }
      },
      
      // Save profile changes
      saveProfile() {
        const name = document.getElementById('profile-name').value;
        const sobrietyDate = document.getElementById('profile-sobriety-date').value;
        const homeGroup = document.getElementById('profile-home-group').value;
        const phone = document.getElementById('profile-phone').value;
        const email = document.getElementById('profile-email').value;
        
        try {
          // Update in database
          window.Database.userOperations.update(this.user.id, {
            name,
            sobrietyDate,
            homeGroup,
            phone,
            email
          });
          
          // Update user in app state
          Object.assign(this.user, {
            name,
            sobrietyDate,
            homeGroup,
            phone,
            email
          });
          
          // Update profile view
          this.updateProfileView();
          
          // Return to dashboard
          this.navigateTo('dashboard');
          
        } catch (error) {
          console.error('Error updating profile:', error);
          alert('There was an error updating your profile. Please try again.');
        }
      },
      
      // Show an error message
      showError(message) {
        const appContainer = document.getElementById('app');
        appContainer.innerHTML = `
          <div class="h-screen flex flex-col items-center justify-center p-4">
            <div class="text-center">
              <i class="fa-solid fa-exclamation-circle text-red-500 text-5xl mb-4"></i>
              <h1 class="text-2xl font-bold text-gray-800 mb-2">Something went wrong</h1>
              <p class="text-gray-600 mb-6">${message}</p>
              <button onclick="window.location.reload()" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">
                Reload Application
              </button>
            </div>
          </div>
        `;
      }
    };
    
    // Initialize the app when the page loads
    document.addEventListener('DOMContentLoaded', () => {
      app.init();
    });
  </script>
</body>
</html>